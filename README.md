# supabasechat

```sql
create table public.users (
  id uuid references auth.users not null primary key,
  name varchar(18) UNIQUE
);

create table public.rooms (
  id bigint generated by default as identity primary key,
  inserted_at timestamp with time zone default timezone('utc' :: text, now()) not null,
  name varchar(32)
);
comment on table public.rooms is 'Room at which the chats happen.';

create table public.participants (
  id bigint generated by default as identity primary key,
  inserted_at timestamp with time zone default timezone('utc' :: text, now()) not null,
  room_id bigint references public.rooms not null,
  user_id uuid references public.users not null
);
comment on table public.participants is 'Table that holds which room has who';

create table public.messages (
  id bigint generated by default as identity primary key,
  inserted_at timestamp with time zone default timezone('utc' :: text, now()) not null,
  message varchar(500),
  user_id uuid references public.users not null,
  room_id bigint references public.rooms not null
);
comment on table public.messages is 'Individual messages sent by each user.';

create view recent_chats as
select
  rooms.id,
  rooms.name,
  messages.id as message_id,
  messages.inserted_at as message_inserted_at,
  messages.message,
  messages.user_id,
  users.name as user_name
from
  rooms
  join messages on rooms.id = messages.room_id
  join users on messages.user_id = users.id
WHERE messages.inserted_at = 
  (SELECT MAX(m2.inserted_at)
  FROM messages m2
  WHERE m2.room_id = messages.room_id);
comment on view public.recent_chats is 'List of recent chats in each rooms';

```